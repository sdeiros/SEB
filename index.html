<!DOCTYPE html>
<html>

<head>
    <title>Tela Principal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Font Awesome -->
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }

        #loginContainer {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #logo {
            display: block;
            margin: 0 auto 20px;
            width: 100px;
        }

        #dadosUsuario {
            display: none;
            margin-top: 20px;
        }

        .btn-custom {
            background-color: #007bff;
            color: white;
            width: 100%;
            margin-right: 10px;
            /* Espaço entre os botões */
        }

        .btn-custom:hover {
            background-color: #0056b3;
        }

        #mensagem {
            color: red;
            margin-top: 10px;
        }

        #secaoBoletins {
            display: none;
            /* Oculta inicialmente a seção de boletins */
        }

        .icon-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="loginContainer" class="container">
        <form id="loginForm" class="form-group">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/Simbolo_ISERJ.png" alt="Logo" id="logo">
            <div class="form-group">
                <label for="usuario">E-mail Institucional ou CPF:</label>
                <input type="text" id="usuario" name="usuario" class="form-control" required>
                <small class="form-text text-muted">CPF: apenas os números</small>
            </div>

            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" name="senha" class="form-control" required>
                <input type="checkbox" onclick="togglePassword()"> Mostrar Senha
            </div>

            <a href="#" class="d-block mb-3" onclick="recuperarSenha()">Esqueci a senha</a>
            <button type="button" class="btn btn-custom" onclick="realizarLogin()">Entrar</button>

            <p id="mensagem"></p>

        </form>
    </div>

    <div id="dadosUsuario" class="container">
        <h2 id="nomeUsuario"></h2>
        <p id="matriculaData"></p> <!-- Adicionado para mostrar matrícula e data -->
        <ul id="listaDocumentos"></ul>

        <!-- Botões adicionais -->
        <div class="mt-3 d-flex justify-content-between">
            <button class="btn btn-custom" onclick="mostrarBoletins()">Boletins</button>
            <button class="btn btn-custom" onclick="mostrarInformacoes()">Informações</button>
            <button class="btn btn-custom" onclick="mostrarDeclaracaoEscolar()">Declaração Escolar</button>
            <button class="btn btn-custom" onclick="mostrarContato()">Contato</button>
        </div>
    </div>


    <!-- Seção de Boletins -->
    <div id="secaoBoletins" class="container">
        <button class="icon-btn" onclick="voltarParaInicio()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2>Boletins</h2>
        <ul id="listaDocumentosBoletins"></ul> <!-- Lista para os documentos de boletins -->
    </div>


    <div id="secaoInformacoes" class="container" style="display: none;">
        <button class="icon-btn" onclick="voltarParaInicio()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2>Informações</h2>
        <ul>
            <li><strong>Nome Completo:</strong> <span id="infoNomeCompleto"></span></li>
            <li><strong>Matrícula:</strong> <span id="infoMatricula"></span></li>
            <li><strong>Turma:</strong> <span id="infoTurma"></span></li><br><br>
            <li><strong>Pai:</strong> <span id="infoPai"></span></li>
            <li><strong>Mãe:</strong> <span id="infoMae"></span></li><br><br>
            <li><strong>Data de Nascimento:</strong> <span id="infoNascimento"></span></li>
            <li><strong>CPF:</strong> <span id="infoCPF"></span></li>
        </ul>
    </div>



    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>
        // Variáveis globais para armazenar as informações do usuário
        var storedMatricula = "";
        var storedTurma = "";
        var storedNascimento = "";
        var storedPai = "";
        var storedMae = "";

        // Função para realizar o login na página index
        function realizarLogin() {
            var usuario = document.getElementById("usuario").value; // Obtém o valor do campo de usuário
            var senha = document.getElementById("senha").value; // Obtém o valor do campo de senha

            // Fazer a requisição para a planilha usando a API do Google Sheets
            fetch('https://sheets.googleapis.com/v4/spreadsheets/1PIhLjXNYtbikhyCQCgSff_DL3b0w9L7n9EtRwGUBG-M/values/A:I?key=AIzaSyBA9ar3yt4yUbSVIE9ubrQ5sQuPuz2iWmA')
                .then(response => response.json()) // Converter a resposta para JSON
                .then(data => {
                    var rows = data.values; // Obter as linhas da planilha

                    // Adicione um log para verificar a estrutura da resposta
                    console.log('Dados retornados:', data);

                    var loginSuccessful = false;
                    var nomeCompleto = "";
                    var matricula = "";

                    // Verificar se as credenciais são válidas (procurar a partir da 3ª linha da planilha)
                    for (var i = 2; i < rows.length; i++) {
                        var row = rows[i];
                        
                        // Verifica se a linha possui colunas suficientes
                        if (row.length < 9) {
                            console.error(`Linha ${i} não possui colunas suficientes. Tamanho da linha: ${row.length}`);
                            continue; // Pula para a próxima linha
                        }

                        var storedEmail = row[2]; // A coluna C contém os e-mails
                        var storedCPF = row[1]; // A coluna B contém os CPFs
                        var storedSenha = row[10]; // A coluna I contém as senhas
                        var storedNomeCompleto = row[0]; // A coluna A contém o nome completo
                        storedMatricula = row[3]; // A coluna D contém a matrícula
                        storedTurma = row[4]; // A coluna E contém a turma
                        storedNascimento = row[5]; // A coluna F contém a data de nascimento
                        storedPai = row[6]; // A coluna G contém o nome do pai
                        storedMae = row[7]; // A coluna H contém o nome da mãe

                        // Verifica as credenciais
                        if ((usuario === storedEmail || usuario === storedCPF) && senha === storedSenha) {
                            loginSuccessful = true;
                            nomeCompleto = storedNomeCompleto;
                            matricula = storedMatricula; // Atribui a matrícula correta
                            break;
                        }
                    }

                    if (loginSuccessful) {
                        document.getElementById("loginContainer").style.display = "none";
                        document.getElementById("dadosUsuario").style.display = "block";
                        var nomeUsuario = nomeCompleto.split(" ");
                        var primeiroNome = nomeUsuario[0];
                        var segundoNome = nomeUsuario[1];

                        // Obtém a hora atual para definir a saudação
                        var horaAtual = new Date().getHours();
                        var saudacao;

                        if (horaAtual < 12) {
                            saudacao = "Bom dia,";
                        } else if (horaAtual < 18) {
                            saudacao = "Boa tarde,";
                        } else {
                            saudacao = "Boa noite,";
                        }

                        // Formata a data de hoje
                        var hoje = new Date();
                        var dia = String(hoje.getDate()).padStart(2, '0');
                        var mes = String(hoje.getMonth() + 1).padStart(2, '0');
                        var ano = hoje.getFullYear();

                        // Converte a matrícula para string, se necessário
                        matricula = matricula ? matricula.toString() : "N/A";

                        document.getElementById("nomeUsuario").textContent = saudacao + " " + primeiroNome + " " + segundoNome + "!";
                        document.getElementById("matriculaData").innerHTML = "<em>" + matricula + "</em> • <em>" + dia + "/" + mes + "/" + ano + "</em>";

                        // Preencher a seção de "Informações"
                        document.getElementById("infoNomeCompleto").textContent = nomeCompleto; // Adiciona o nome completo
                        document.getElementById("infoCPF").textContent = storedCPF; // Adiciona o CPF
                        document.getElementById("infoMatricula").textContent = storedMatricula;
                        document.getElementById("infoTurma").textContent = storedTurma;
                        document.getElementById("infoNascimento").textContent = storedNascimento;
                        document.getElementById("infoPai").textContent = storedPai;
                        document.getElementById("infoMae").textContent = storedMae;

                        // Chamar a função buscarDocumentosDoUsuario para exibir os documentos do usuário
                        buscarDocumentosDoUsuario(nomeCompleto, '1HBQi31Er40Nni8uaDzFwUHLl-iirdB-q');
                    } else {
                        document.getElementById("mensagem").textContent = "Usuário ou senha incorretos!";

                        // Recarregar a página após 2 segundos
                        //setTimeout(function () {
                        //location.reload(); // Recarregar a página
                        //  }, //1000); // 2000ms = 2 segundos
                    }

                })
                .catch(error => {
                    console.log("Erro ao acessar a planilha:", error);
                });
        }

        function togglePassword() {
            var senha = document.getElementById("senha");
            senha.type = senha.type === "password" ? "text" : "password";
        }


        // Função para recuperar a senha
        function recuperarSenha() {
            window.open("./resetsenha.html", "_blank"); // Redireciona para o arquivo HTML local
        }


        // Função para mostrar a seção de boletins
        function mostrarBoletins() {
            document.getElementById("dadosUsuario").style.display = "none"; // Oculta os dados do usuário
            document.getElementById("secaoBoletins").style.display = "block"; // Mostra a seção de boletins

            var nomeCompleto = document.getElementById("nomeUsuario").textContent.split(", ")[1]; // Obter o nome completo
            buscarDocumentosDoUsuario(nomeCompleto, '1HBQi31Er40Nni8uaDzFwUHLl-iirdB-q'); // Chama a função para buscar documentos
        }

        // Função para buscar e exibir os documentos do usuário
        function buscarDocumentosDoUsuario(nomeUsuario, folderId) {
            var url = "https://www.googleapis.com/drive/v3/files?q=name%20contains%20%27" + encodeURIComponent(nomeUsuario) + "%27%20and%20%27" + encodeURIComponent(folderId) + "%27%20in%20parents&key=AIzaSyDDBEKKqEsvTDb66TbmvtfZMb8wyStdnXk";

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var files = data.files;
                    var listaDocumentos = document.getElementById('listaDocumentosBoletins'); // Atualiza para usar a lista de boletins
                    listaDocumentos.innerHTML = '';

                    if (files && files.length > 0) {
                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            var documentoNome = file.name;
                            var documentoId = file.id;
                            var documentoLink = "https://drive.google.com/file/d/" + documentoId;
                            var listItem = document.createElement('li');
                            var link = document.createElement('a');
                            link.href = documentoLink;
                            link.textContent = documentoNome;
                            listItem.appendChild(link);
                            listaDocumentos.appendChild(listItem);
                        }
                    } else {
                        document.getElementById("mensagem").textContent = 'Nenhum documento encontrado.';
                    }
                })
                .catch(error => {
                    console.log("Erro ao obter os dados do Google Drive: " + error);
                });
        }

        // Função para voltar à tela inicial
        function voltarParaInicio() {
            document.getElementById("secaoInformacoes").style.display = "none"; // Oculta a seção de boletins
            document.getElementById("secaoBoletins").style.display = "none"; // Oculta a seção de boletins
            document.getElementById("dadosUsuario").style.display = "block"; // Mostra novamente os dados do usuário
        }

        function mostrarInformacoes() {
            document.getElementById("dadosUsuario").style.display = "none";
            document.getElementById("secaoInformacoes").style.display = "block";
        }

        function mostrarDeclaracaoEscolar() {
            alert('Aqui você pode adicionar declaração escolar!');
        }

        function mostrarContato() {
            alert('Aqui você pode adicionar informações de contato!');
        }

        function recuperarSenha() {
            alert('Aqui você pode implementar a recuperação de senha!');
        }
    </script>
</body>

</html>
