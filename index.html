<!DOCTYPE html>
<html>

<head>
    <title>ISERJ | Portal do Aluno</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" sizes="180x180" href="fav-icon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="fav-icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="fav-icon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="fav-icon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="fav-icon/android-chrome-512x512.png">
    <link rel="icon" href="fav-icon/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="fav-icon/site.webmanifest">

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }

        #loginContainer {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #logo {
            display: block;
            margin: 0 auto 20px;
            width: 100px;
        }

        #dadosUsuario {
            display: none;
            margin-top: 20px;
        }

        .btn-custom {
            background-color: #007bff;
            color: white;
            width: 100%;
            margin-right: 10px;
            /* Espaço entre os botões */
        }

        .btn-custom:hover {
            background-color: #0056b3;
        }

        #mensagem {
            color: red;
            margin-top: 10px;
        }

        #secaoBoletins {
            display: none;
            /* Oculta inicialmente a seção de boletins */
        }

        .icon-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="loginContainer" class="container">
        <form id="loginForm" class="form-group">
            <img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/Simbolo_ISERJ.png" alt="Logo" id="logo">
            <div class="form-group">
                <label for="usuario">E-mail Institucional ou CPF:</label>
                <input type="text" id="usuario" name="usuario" class="form-control" required>
                <small class="form-text text-muted">CPF: apenas os números</small>
            </div>

            <div class="form-group">
                <label for="senha">Senha:</label>
                <input type="password" id="senha" name="senha" class="form-control" required>
                <input type="checkbox" onclick="togglePassword()"> Mostrar Senha
            </div>

            <a href="#" class="d-block mb-3" onclick="recuperarSenha()">Esqueci a senha</a>
            <button type="button" class="btn btn-custom" onclick="realizarLogin()">Entrar</button>

            <p id="mensagem"></p>

        </form>
    </div>

    <div id="dadosUsuario" class="container">
        <h2 id="nomeUsuario"></h2>
        <p id="matriculaData"></p> <!-- Adicionado para mostrar matrícula e data -->
        <ul id="listaDocumentos"></ul>

        <!-- Botões adicionais -->
        <div id="botaoSecao">
            <button class=" btn btn-custom" onclick="mostrarBoletins()">Boletins</button>
            <button class="btn btn-custom" onclick="mostrarInformacoes()">Informações</button>
            <button class="btn btn-custom" onclick="mostrarDeclaracaoEscolar()">Declaração Escolar</button>
            <button class="btn btn-custom" onclick="mostrarContato()">Contato</button>
        </div>
    </div>

    <!-- Seção de Boletins -->
    <div id="secaoBoletins" class="container">
        <button class="icon-btn" onclick="voltarParaInicio()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2>Boletins</h2>
        <ul id="listaDocumentosBoletins"></ul> <!-- Lista para os documentos de boletins -->
    </div>


    <!-- Seção de Notificações -->
    <div id="secaoNotificacoes" class="container" style="display: none;">
        <button class="icon-btn" onclick="voltarParaInicio()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2>Enviar Notificação</h2>
        <form id="formNotificacao" class="form-group">
            <div class="form-group">
                <label for="tituloNotificacao">Título:</label>
                <input type="text" id="tituloNotificacao" name="tituloNotificacao" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="mensagemNotificacao">Mensagem:</label>
                <textarea id="mensagemNotificacao" name="mensagemNotificacao" class="form-control" rows="4"
                    required></textarea>
            </div>
            <button type="button" class="btn btn-custom" onclick="enviarNotificacao()">Enviar</button>
        </form>
        <p id="mensagemEnvio"></p>
    </div>

    <div id="secaoInformacoes" class="container" style="display: none;">
        <button class="icon-btn" onclick="voltarParaInicio()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h2>Informações</h2>
        <ul>
            <li><strong>Nome Completo:</strong> <span id="infoNomeCompleto"></span></li>
            <li><strong>Matrícula:</strong> <span id="infoMatricula"></span></li>
            <li><strong>Turma:</strong> <span id="infoTurma"></span></li><br><br>
            <li><strong>Pai:</strong> <span id="infoPai"></span></li>
            <li><strong>Mãe:</strong> <span id="infoMae"></span></li><br><br>
            <li><strong>Data de Nascimento:</strong> <span id="infoNascimento"></span></li>
            <li><strong>CPF:</strong> <span id="infoCPF"></span></li>
        </ul>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // Variáveis globais para armazenar as informações do usuário
        var storedMatricula = "";
        var storedTurma = "";
        var storedNascimento = "";
        var storedPai = "";
        var storedMae = "";
        var storedEndereco = "";
        var storedContato = "";
        var isSecretaria = false; // Para controlar se o login é de secretaria

        // Função para realizar o login
        async function realizarLogin() {
            var usuario = document.getElementById("usuario").value;
            var senha = document.getElementById("senha").value;

            try {
                // Chama a API do Google Sheets para pegar os dados da aba de Alunos
                let responseAlunos = await fetch('https://sheets.googleapis.com/v4/spreadsheets/1PIhLjXNYtbikhyCQCgSff_DL3b0w9L7n9EtRwGUBG-M/values/A:K?key=AIzaSyBA9ar3yt4yUbSVIE9ubrQ5sQuPuz2iWmA');
                let dataAlunos = await responseAlunos.json();
                var rowsAlunos = dataAlunos.values;

                var loginSuccessful = false;
                var nomeCompleto = "";
                var matricula = "";
                var storedCPF = "";

                // Verifica o login na aba de Alunos
                for (var i = 2; i < rowsAlunos.length; i++) {
                    var row = rowsAlunos[i];
                    if (row.length < 9) continue;

                    var storedEmail = row[2];
                    storedCPF = row[1];
                    var storedSenha = row[10];
                    var storedNomeCompleto = row[0];
                    storedEndereco = row[8]; // A coluna I contém o endereço
                    storedContato = row[9]; // A coluna J contém o contato
                    storedMatricula = row[3];
                    storedTurma = row[4];
                    storedNascimento = row[5];
                    storedPai = row[6];
                    storedMae = row[7];

                    if ((usuario === storedEmail || usuario === storedCPF) && senha === storedSenha) {
                        loginSuccessful = true;
                        nomeCompleto = storedNomeCompleto;
                        matricula = storedMatricula;
                        break;
                    }
                }

                // Se não encontrou na aba de Alunos, verifica na aba de Secretaria
                if (!loginSuccessful) {
                    let responseSecretaria = await fetch('https://sheets.googleapis.com/v4/spreadsheets/1PIhLjXNYtbikhyCQCgSff_DL3b0w9L7n9EtRwGUBG-M/values/Secretaria?key=AIzaSyBA9ar3yt4yUbSVIE9ubrQ5sQuPuz2iWmA');
                    let dataSecretaria = await responseSecretaria.json();
                    var rowsSecretaria = dataSecretaria.values;

                    for (var i = 2; i < rowsSecretaria.length; i++) {
                        var row = rowsSecretaria[i];
                        if (row.length < 3) continue;

                        var storedEmail = row[1]; // Supondo que o e-mail está na segunda coluna
                        var storedSenha = row[2]; // Supondo que a senha está na terceira coluna
                        var storedNomeCompleto = row[0]; // Supondo que o nome completo está na primeira coluna

                        if (usuario === storedEmail && senha === storedSenha) {
                            loginSuccessful = true;
                            nomeCompleto = storedNomeCompleto;
                            isSecretaria = true; // Marca como login da secretaria
                            break;
                        }
                    }
                }

                // Aqui você pode adicionar o código para tratar o sucesso ou falha do login
                if (loginSuccessful) {
                    document.getElementById("nomeUsuario").textContent = nomeCompleto + ", Matrícula: " + matricula;
                    document.getElementById("dadosUsuario").style.display = "block"; // Mostra os dados do usuário
                    document.getElementById('loginContainer').style.display = 'none';

                    if (isSecretaria) {
                        // Ocultar o formulário de login
                        document.getElementById('loginContainer').style.display = 'none';

                        // Ocultar botões de seção se necessário
                        document.getElementById('botaoSecao').style.display = 'none';

                        // Exibir o formulário de notificações
                        document.getElementById('secaoNotificacoes').style.display = 'block';
                    } else {
                        console.log("Usuário é aluno");
                        // Exibe os botões de aluno
                        document.getElementById("botaoSecao").style.display = "block";

                        document.getElementById('loginContainer').style.display = 'none';

                        // Se for aluno, mostrar os botões de boletins e informações e esconder a seção de notificações
                        document.getElementById("btnBoletins").style.display = "block";
                        document.getElementById("btnInformacoes").style.display = "block";
                        document.getElementById("secaoNotificacoes").style.display = "none";
                    }

                    // Chamar a função para buscar os documentos do usuário (boletins)
                    buscarDocumentosDoUsuario(nomeCompleto, '1HBQi31Er40Nni8uaDzFwUHLl-iirdB-q');

                } else {
                    document.getElementById("mensagem").textContent = "Usuário ou senha incorretos!";
                }

            } catch (error) {
                console.log("Erro ao acessar a planilha:", error);
            }
        }


        // Função para buscar e exibir os documentos do usuário (boletins)
        function buscarDocumentosDoUsuario(nomeUsuario, folderId) {
            var url = "https://www.googleapis.com/drive/v3/files?q=name%20contains%20%27" + encodeURIComponent(nomeUsuario) + "%27%20and%20%27" + encodeURIComponent(folderId) + "%27%20in%20parents&key=AIzaSyDDBEKKqEsvTDb66TbmvtfZMb8wyStdnXk";

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var files = data.files;
                    var listaDocumentos = document.getElementById('listaDocumentosBoletins'); // Atualiza para usar a lista de boletins
                    listaDocumentos.innerHTML = '';

                    if (files && files.length > 0) {
                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            var documentoNome = file.name;
                            var documentoId = file.id;
                            var documentoLink = "https://drive.google.com/file/d/" + documentoId;
                            var listItem = document.createElement('li');
                            var link = document.createElement('a');
                            link.href = documentoLink;
                            link.textContent = documentoNome;
                            listItem.appendChild(link);
                            listaDocumentos.appendChild(listItem);
                        }
                    } else {
                        document.getElementById("mensagem").textContent = 'Nenhum documento encontrado.';
                    }
                })
                .catch(error => {
                    console.log("Erro ao obter os dados do Google Drive: " + error);
                });
        }

        // Função para mostrar os boletins
        function mostrarBoletins() {
            document.getElementById("dadosUsuario").style.display = "none"; // Oculta os dados do usuário
            document.getElementById("secaoBoletins").style.display = "block"; // Mostra a seção de boletins

            var nomeCompleto = storedMatricula; // Exemplo, você pode mudar para usar a variável que contém o nome do aluno
            buscarDocumentosDoUsuario(nomeCompleto, "ID_DA_PASTA_DE_BOLETINS"); // Altere para o ID correto
        }

        // Função para alternar a visibilidade da senha
        function togglePassword() {
            var senha = document.getElementById("senha");
            senha.type = senha.type === "password" ? "text" : "password";
        }

        // Adiciona o evento de clique ao botão de login após o DOM ser carregado
        document.addEventListener('DOMContentLoaded', function () {
            var botaoLogin = document.getElementById("botaoLogin");
            if (botaoLogin) {
                botaoLogin.onclick = realizarLogin;
            } else {
                console.error("Botão de login não encontrado");
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/sw.js').then(function (registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function (error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
            });
        }
    </script>



</body>

</html>